# 구글 시트 연동 설정 가이드

결제 완료 후 고객 정보를 자동으로 구글 시트에 저장하는 기능입니다.

## 📋 사전 준비

- 구글 계정
- 구글 시트 접근 권한

## 🚀 설정 방법

### 1단계: 구글 시트 생성

1. [Google Sheets](https://sheets.google.com) 접속
2. 새 스프레드시트 만들기
3. 스프레드시트 이름: `운명테라피 주문 관리`
4. 시트 탭 이름을 **"주문"**으로 변경 (중요!)

### 2단계: 앱스 스크립트 설정

1. 구글 시트에서 **확장 프로그램 > Apps Script** 메뉴 클릭
2. 새 프로젝트 생성됨
3. `code.gs` 파일의 모든 내용을 삭제
4. `google-apps-script/code.gs` 파일의 내용을 복사하여 붙여넣기
5. **저장** 버튼 클릭 (Ctrl+S 또는 Cmd+S)
6. 프로젝트 이름: `운명테라피 주문 수집`

### 3단계: 웹 앱 배포

1. 앱스 스크립트 에디터 우측 상단 **배포 > 새 배포** 클릭
2. **유형 선택** 클릭 → **웹 앱** 선택
3. 설정:
   - **설명**: `운명테라피 주문 자동 수집 v1`
   - **다음 계정으로 실행**: **나**
   - **액세스 권한**: **모든 사용자** ⚠️ 중요!
4. **배포** 버튼 클릭
5. 권한 승인:
   - **액세스 권한 검토** 클릭
   - 본인 구글 계정 선택
   - **고급** 클릭 → **[프로젝트명](안전하지 않음)으로 이동** 클릭
   - **허용** 클릭
6. **웹 앱 URL** 복사 (예: `https://script.google.com/macros/s/AKfycby.../exec`)

### 4단계: Vercel 환경 변수 설정

1. [Vercel Dashboard](https://vercel.com) 접속
2. `unmyoung` 프로젝트 선택
3. **Settings > Environment Variables** 메뉴
4. 새 환경 변수 추가:
   - **Name**: `NEXT_PUBLIC_GOOGLE_SHEET_URL`
   - **Value**: 3단계에서 복사한 웹 앱 URL
   - **Environment**: `Production`, `Preview`, `Development` 모두 선택
5. **Save** 클릭

### 5단계: 배포 및 테스트

1. Vercel에서 프로젝트 재배포
   ```bash
   vercel --prod
   ```
2. 테스트 주문 진행
3. 구글 시트 확인 - 자동으로 데이터가 추가되었는지 확인

## 📊 구글 시트 데이터 구조

### 1인 분석

| 번호 | 주문일시 | 주문ID | 패키지 | 결제금액 | 분석인원 | 이름 | 생년월일 | 양력/음력 | 생시 | 성별 | 이메일 | 결제상태 | 처리상태 | 비고 |
|------|----------|--------|--------|----------|----------|------|----------|-----------|------|------|--------|----------|----------|------|
| 1 | 2026-01-20 21:30:00 | ORDER_... | 프리미엄 종합 분석 | 39000 | 1 | 홍길동 | 1990-01-01 | 양력 | 오시 | 남성 | hong@example.com | 결제완료 | 대기중 | |

### 다인 분석 (2인 예시)

| 번호 | 주문일시 | 주문ID | 패키지 | 결제금액 | 분석인원 | [1] 이름 | [1] 생년월일 | [1] 양력/음력 | [1] 생시 | [1] 성별 | [1] 이메일 | [2] 이름 | [2] 생년월일 | ... | 결제상태 | 처리상태 | 비고 |
|------|----------|--------|--------|----------|----------|----------|--------------|---------------|----------|----------|------------|----------|--------------|-----|----------|----------|------|
| 1 | 2026-01-20 21:30:00 | ORDER_... | 프리미엄 종합 분석 | 70000 | 2 | [1] 홍길동 | 1990-01-01 | 양력 | 오시 | 남성 | hong@... | [2] 김영희 | 1992-03-15 | ... | 결제완료 | 대기중 | |

## 🎨 자동 스타일링

앱스 스크립트는 자동으로 다음 스타일을 적용합니다:

- **헤더**: 파란색 배경, 흰색 글자
- **번호 열**: 연한 파란색 배경
- **다인 분석**: 각 분석 대상자별로 다른 배경색
- **테두리**: 모든 셀에 테두리 자동 적용

## 🔧 테스트 방법

### 앱스 스크립트에서 직접 테스트

1. 앱스 스크립트 에디터에서 함수 선택: `testAddOrder`
2. **실행** 버튼 클릭
3. 구글 시트에서 테스트 데이터 확인

### 웹 앱 URL로 테스트 (Postman 등)

```bash
curl -X POST "YOUR_WEB_APP_URL" \
  -H "Content-Type: application/json" \
  -d '{
    "orderId": "ORDER_TEST_123",
    "packageName": "프리미엄 종합 분석",
    "amount": 39000,
    "personCount": 1,
    "personsData": [{
      "name": "테스트",
      "birthDate": "1990-01-01",
      "calendarType": "solar",
      "birthTime": "오시",
      "gender": "male",
      "email": "test@example.com"
    }]
  }'
```

## ⚠️ 주의사항

1. **시트 이름**: 반드시 "주문"이어야 합니다.
2. **액세스 권한**: "모든 사용자"로 설정해야 외부에서 접근 가능
3. **URL 보안**: 웹 앱 URL은 민감한 정보이므로 외부에 공개하지 마세요
4. **데이터 백업**: 정기적으로 구글 시트를 백업하세요

## 🔄 배포 업데이트

코드를 수정한 경우:

1. 앱스 스크립트 에디터에서 코드 수정
2. **배포 > 배포 관리** 클릭
3. 현재 배포 버전 우측 **편집** (연필 아이콘) 클릭
4. **버전**: **새 버전** 선택
5. **배포** 클릭

## 📞 문제 해결

### 데이터가 저장되지 않음

1. 앱스 스크립트 **실행 > 실행 로그** 확인
2. 웹 앱 URL이 올바른지 확인
3. 시트 이름이 "주문"인지 확인
4. 권한 설정이 "모든 사용자"인지 확인

### 권한 오류

- 앱스 스크립트 재배포 후 다시 권한 승인

### URL 변경됨

- 재배포 시 URL이 변경되지 않습니다
- 하지만 처음 배포할 때는 새 URL이 생성됩니다

## 📚 추가 기능

### 알림 설정 (선택사항)

새 주문이 들어올 때 이메일 알림을 받고 싶다면:

```javascript
// code.gs 파일의 addSinglePersonOrder 또는 addMultiPersonOrder 함수 마지막에 추가
MailApp.sendEmail({
  to: "your-email@example.com",
  subject: "새 주문 알림 - " + data.packageName,
  body: "새로운 주문이 접수되었습니다.\n주문번호: " + data.orderId
});
```

### 슬랙 연동 (선택사항)

슬랙 웹훅 URL을 사용하여 알림을 받을 수 있습니다.

## ✅ 완료

모든 설정이 완료되었습니다! 이제 결제가 완료될 때마다 자동으로 구글 시트에 고객 정보가 저장됩니다.
